<!DOCTYPE html>
<html>
<head>
    <title>Avaliar Conversas - J√∫lia</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            max-width: 1200px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .conversa-item { 
            border: 1px solid #ddd; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 8px; 
            cursor: pointer; 
            background: white;
        }
        .conversa-item:hover { 
            background: #f5f5f5; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .mensagem { 
            padding: 10px; 
            margin: 5px 0; 
            border-radius: 8px; 
        }
        .mensagem.medico { 
            background: #e3f2fd; 
            text-align: left; 
        }
        .mensagem.julia { 
            background: #e8f5e9; 
            text-align: right; 
        }
        .avaliacao-form { 
            background: #fff3e0; 
            padding: 20px; 
            border-radius: 8px; 
            margin-top: 20px; 
        }
        .score-input { 
            display: flex; 
            gap: 20px; 
            margin: 10px 0; 
        }
        .score-input label { 
            min-width: 120px; 
        }
        .score-input input { 
            width: 60px; 
        }
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            z-index: 1000;
        }
        .modal-content { 
            background: white; 
            margin: 5% auto; 
            padding: 20px; 
            width: 80%; 
            max-height: 80%; 
            overflow-y: auto; 
            border-radius: 8px; 
        }
        .tag { 
            display: inline-block; 
            background: #e0e0e0; 
            padding: 2px 8px; 
            border-radius: 4px; 
            margin: 2px; 
            font-size: 12px; 
        }
        .tag.selected {
            background: #4CAF50;
            color: white;
        }
        .close {
            float: right;
            cursor: pointer;
            font-size: 24px;
            font-weight: bold;
        }
        .close:hover {
            color: #f44336;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìù Avaliar Conversas</h1>

        <div>
            <label>Filtrar:</label>
            <select id="filtro-avaliada" onchange="carregarConversas()">
                <option value="">Todas</option>
                <option value="false">N√£o avaliadas</option>
                <option value="true">Avaliadas</option>
            </select>
        </div>

        <div id="lista-conversas"></div>
    </div>

    <!-- Modal de avalia√ß√£o -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fecharModal()">&times;</span>
            <h2>Conversa com <span id="nome-medico"></span></h2>
            <div id="mensagens"></div>

            <div class="avaliacao-form">
                <h3>Avalia√ß√£o</h3>
                <div class="score-input">
                    <label>Naturalidade (1-10):</label>
                    <input type="number" id="score-naturalidade" min="1" max="10">
                </div>
                <div class="score-input">
                    <label>Persona (1-10):</label>
                    <input type="number" id="score-persona" min="1" max="10">
                </div>
                <div class="score-input">
                    <label>Objetivo (1-10):</label>
                    <input type="number" id="score-objetivo" min="1" max="10">
                </div>
                <div class="score-input">
                    <label>Satisfa√ß√£o (1-10):</label>
                    <input type="number" id="score-satisfacao" min="1" max="10">
                </div>

                <div style="margin-top: 15px;">
                    <label>Notas:</label>
                    <textarea id="notas" rows="3" style="width:100%"></textarea>
                </div>

                <div style="margin-top: 15px;">
                    <label>Tags:</label>
                    <div id="tags-container"></div>
                    <input type="text" id="nova-tag" placeholder="Adicionar tag..." onkeypress="adicionarTag(event)">
                </div>

                <button onclick="salvarAvaliacao()" style="margin-top:20px;padding:10px 20px;background:#4CAF50;color:white;border:none;border-radius:4px;cursor:pointer;">Salvar Avalia√ß√£o</button>
            </div>
        </div>
    </div>

    <script>
        let conversaAtual = null;
        let tagsAtuais = [];
        const tagsPredefinidas = {
            qualidade: ["resposta_excelente", "resposta_boa", "resposta_ruim", "perdeu_persona", "muito_formal", "muito_informal"],
            situacao: ["vaga_reservada", "sem_interesse", "indeciso", "precisa_followup", "optout"],
            problema: ["erro_informacao", "resposta_inadequada", "deveria_handoff", "handoff_desnecessario", "tempo_lento"],
            destaque: ["usar_como_exemplo", "precisa_ajuste_prompt", "bug_detectado"]
        };

        function renderizarTags() {
            const container = document.getElementById('tags-container');
            let html = '<div style="margin-bottom: 10px;">';
            
            for (const [categoria, tags] of Object.entries(tagsPredefinidas)) {
                html += `<strong>${categoria}:</strong> `;
                tags.forEach(tag => {
                    const selected = tagsAtuais.includes(tag) ? 'selected' : '';
                    html += `<span class="tag ${selected}" onclick="toggleTag('${tag}')">${tag}</span> `;
                });
                html += '<br>';
            }
            
            html += '</div>';
            html += '<div>Tags selecionadas: <span id="tags-selecionadas"></span></div>';
            container.innerHTML = html;
            atualizarTagsSelecionadas();
        }

        function toggleTag(tag) {
            const index = tagsAtuais.indexOf(tag);
            if (index > -1) {
                tagsAtuais.splice(index, 1);
            } else {
                tagsAtuais.push(tag);
            }
            renderizarTags();
        }

        function atualizarTagsSelecionadas() {
            const span = document.getElementById('tags-selecionadas');
            if (tagsAtuais.length > 0) {
                span.innerHTML = tagsAtuais.map(t => `<span class="tag selected">${t}</span>`).join(' ');
            } else {
                span.innerHTML = '<em>Nenhuma tag selecionada</em>';
            }
        }

        function adicionarTag(event) {
            if (event.key === 'Enter') {
                const input = document.getElementById('nova-tag');
                const tag = input.value.trim();
                if (tag && !tagsAtuais.includes(tag)) {
                    tagsAtuais.push(tag);
                    renderizarTags();
                    input.value = '';
                }
            }
        }

        async function carregarConversas() {
            const avaliada = document.getElementById('filtro-avaliada').value;
            const url = `/admin/conversas?limite=50${avaliada ? `&avaliada=${avaliada}` : ''}`;
            
            try {
                const resp = await fetch(url);
                const data = await resp.json();

                document.getElementById('lista-conversas').innerHTML = (data.conversas || []).map(c => `
                    <div class="conversa-item" onclick="abrirConversa('${c.id}')">
                        <strong>${c.clientes?.primeiro_nome || 'M√©dico'}</strong>
                        <span class="tag">${c.status || 'N/A'}</span>
                        ${(c.avaliacoes_qualidade || []).some(a => a.avaliador === 'gestor') ? '<span class="tag" style="background:#c8e6c9">‚úì Avaliada</span>' : ''}
                        <br>
                        <small>Score auto: ${c.avaliacoes_qualidade?.[0]?.score_geral || '-'}/10</small>
                        <small> | ${new Date(c.created_at).toLocaleDateString()}</small>
                    </div>
                `).join('');
            } catch (error) {
                document.getElementById('lista-conversas').innerHTML = `<div style="color:red;">Erro ao carregar conversas: ${error.message}</div>`;
            }
        }

        async function abrirConversa(id) {
            try {
                const resp = await fetch(`/admin/conversas/${id}`);
                const data = await resp.json();
                conversaAtual = data;

                document.getElementById('nome-medico').textContent = data.conversa?.clientes?.primeiro_nome || 'M√©dico';
                document.getElementById('mensagens').innerHTML = (data.interacoes || []).map(i => `
                    <div class="mensagem ${i.direcao === 'entrada' || i.autor_tipo === 'medico' ? 'medico' : 'julia'}">
                        <small>${i.direcao === 'entrada' || i.autor_tipo === 'medico' ? 'üë®‚Äç‚öïÔ∏è' : 'üë©‚Äçüíº'}</small>
                        ${i.conteudo || ''}
                        <br><small style="color:#999">${new Date(i.created_at).toLocaleTimeString()}</small>
                    </div>
                `).join('');

                // Limpar formul√°rio
                document.getElementById('score-naturalidade').value = '';
                document.getElementById('score-persona').value = '';
                document.getElementById('score-objetivo').value = '';
                document.getElementById('score-satisfacao').value = '';
                document.getElementById('notas').value = '';
                tagsAtuais = [];
                renderizarTags();

                document.getElementById('modal').style.display = 'block';
            } catch (error) {
                alert(`Erro ao carregar conversa: ${error.message}`);
            }
        }

        function fecharModal() {
            document.getElementById('modal').style.display = 'none';
            conversaAtual = null;
        }

        async function salvarAvaliacao() {
            if (!conversaAtual) {
                alert('Nenhuma conversa selecionada');
                return;
            }

            const avaliacao = {
                conversa_id: conversaAtual.conversa.id,
                naturalidade: parseInt(document.getElementById('score-naturalidade').value),
                persona: parseInt(document.getElementById('score-persona').value),
                objetivo: parseInt(document.getElementById('score-objetivo').value),
                satisfacao: parseInt(document.getElementById('score-satisfacao').value),
                notas: document.getElementById('notas').value,
                tags: tagsAtuais
            };

            // Valida√ß√£o
            if (!avaliacao.naturalidade || !avaliacao.persona || !avaliacao.objetivo || !avaliacao.satisfacao) {
                alert('Preencha todos os scores (1-10)');
                return;
            }

            try {
                const resp = await fetch('/admin/avaliacoes', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(avaliacao)
                });

                if (resp.ok) {
                    alert('Avalia√ß√£o salva!');
                    fecharModal();
                    carregarConversas();
                } else {
                    const error = await resp.json();
                    alert(`Erro ao salvar: ${error.erro || 'Erro desconhecido'}`);
                }
            } catch (error) {
                alert(`Erro ao salvar avalia√ß√£o: ${error.message}`);
            }
        }

        // Fechar modal ao clicar fora
        window.onclick = function(event) {
            const modal = document.getElementById('modal');
            if (event.target == modal) {
                fecharModal();
            }
        }

        // Inicializar
        renderizarTags();
        carregarConversas();
    </script>
</body>
</html>

