# E46.2 - Tipos TypeScript

## Resumo

Criar todas as interfaces e tipos TypeScript para o modulo de Market Intelligence, garantindo type safety em todo o codigo.

## Contexto

Os tipos devem refletir exatamente as estruturas do banco de dados e os contratos das APIs. Serao usados tanto no backend (API routes) quanto no frontend (componentes).

## Escopo

### Incluido
- Tipos de entidades do banco
- Tipos de request/response das APIs
- Tipos de props dos componentes
- Tipos utilitarios
- Type guards

### Excluido
- Implementacao de funcoes (apenas tipos)
- Validacao em runtime (sera Zod em outro arquivo)

---

## Especificacao Tecnica

### Arquivo: `dashboard/types/market-intelligence.ts`

```typescript
/**
 * Market Intelligence Types - Sprint 46
 *
 * Tipos TypeScript para o modulo de Market Intelligence.
 * Refletem as estruturas do banco de dados e contratos de API.
 */

// =============================================================================
// ENUMS
// =============================================================================

/**
 * Periodos disponiveis para filtros de analytics
 */
export type AnalyticsPeriod = '7d' | '30d' | '90d' | 'custom'

/**
 * Status de uma vaga no pipeline
 */
export type VagaGroupStatus =
  | 'pendente'
  | 'processando'
  | 'importada'
  | 'revisao'
  | 'descartada'
  | 'duplicada'

/**
 * Niveis de confianca para classificacao
 */
export type ConfidenceLevel = 'alta' | 'media' | 'baixa'

// =============================================================================
// ENTIDADES DO BANCO
// =============================================================================

/**
 * Snapshot diario de market intelligence
 * Tabela: market_intelligence_daily
 */
export interface MarketIntelligenceDaily {
  id: string
  data: string // ISO date string YYYY-MM-DD

  // Metricas de Volume
  gruposAtivos: number
  mensagensTotal: number
  mensagensComOferta: number
  vagasExtraidas: number
  vagasImportadas: number
  vagasDuplicadas: number
  vagasDescartadas: number

  // Taxas (0-1)
  taxaDeteccaoOferta: number | null
  taxaExtracao: number | null
  taxaImportacao: number | null
  taxaDuplicatas: number | null

  // Qualidade (0-1)
  confiancaMediaExtracao: number | null
  confiancaMediaMatch: number | null

  // Valor (em centavos)
  valorMedioPlantao: number | null
  valorMedianoPlantao: number | null
  valorMinimoPlantao: number | null
  valorMaximoPlantao: number | null

  // Metadata
  createdAt: string
  updatedAt: string
}

/**
 * Ranking de grupo
 * View: mv_grupos_ranking
 */
export interface GrupoRanking {
  grupoId: string
  grupoNome: string
  grupoTipo: string | null
  grupoRegiao: string | null
  grupoAtivo: boolean

  // Metricas 30 dias
  mensagens30d: number
  ofertas30d: number
  vagasExtraidas30d: number
  vagasImportadas30d: number

  // Qualidade
  confiancaMedia30d: number | null
  valorMedio30d: number | null
  scoreQualidade: number // 0-100

  // Timestamps
  ultimaMensagemEm: string | null
  ultimaVagaEm: string | null
  calculatedAt: string
}

/**
 * Metricas do pipeline por dia
 * View: mv_pipeline_metrics
 */
export interface PipelineMetrics {
  data: string // ISO date string YYYY-MM-DD

  // Etapa 1: Mensagens
  mensagensTotal: number
  mensagensProcessadas: number
  mensagensPassouHeuristica: number
  mensagensEhOferta: number

  // Etapa 2: Vagas Extraidas
  vagasExtraidas: number
  vagasDadosOk: number
  vagasDuplicadas: number

  // Etapa 3: Vagas Importadas
  vagasImportadas: number
  vagasRevisao: number
  vagasDescartadas: number

  // Confianca
  confiancaClassificacaoMedia: number | null
  confiancaExtracaoMedia: number | null

  calculatedAt: string
}

// =============================================================================
// API REQUESTS
// =============================================================================

/**
 * Parametros para API de overview
 */
export interface MarketOverviewParams {
  period: AnalyticsPeriod
  startDate?: string // ISO date, requerido se period === 'custom'
  endDate?: string   // ISO date, requerido se period === 'custom'
}

/**
 * Parametros para API de volume
 */
export interface MarketVolumeParams {
  period: AnalyticsPeriod
  startDate?: string
  endDate?: string
  groupBy?: 'day' | 'week' | 'month'
}

/**
 * Parametros para API de pipeline
 */
export interface MarketPipelineParams {
  period: AnalyticsPeriod
  startDate?: string
  endDate?: string
}

/**
 * Parametros para API de ranking de grupos
 */
export interface GroupsRankingParams {
  limit?: number       // default: 20, max: 100
  offset?: number      // default: 0
  sortBy?: 'score' | 'vagas' | 'mensagens' | 'valor'
  order?: 'asc' | 'desc'
  apenasAtivos?: boolean
}

// =============================================================================
// API RESPONSES
// =============================================================================

/**
 * Response da API de overview
 */
export interface MarketOverviewResponse {
  periodo: {
    inicio: string
    fim: string
    dias: number
  }

  kpis: {
    gruposAtivos: KPIMetric
    vagasPorDia: KPIMetric
    taxaConversao: KPIMetric
    valorMedio: KPIMetric
  }

  resumo: {
    totalMensagens: number
    totalOfertas: number
    totalVagasExtraidas: number
    totalVagasImportadas: number
  }

  updatedAt: string
}

/**
 * Metrica de KPI com variacao
 */
export interface KPIMetric {
  valor: number
  valorFormatado: string
  variacao: number | null      // percentual vs periodo anterior
  variacaoTipo: 'up' | 'down' | 'stable' | null
  tendencia: number[]          // ultimos N valores para sparkline
}

/**
 * Response da API de volume
 */
export interface MarketVolumeResponse {
  periodo: {
    inicio: string
    fim: string
  }

  series: VolumeSeries[]

  totais: {
    mensagens: number
    ofertas: number
    vagasExtraidas: number
    vagasImportadas: number
  }

  updatedAt: string
}

/**
 * Serie temporal de volume
 */
export interface VolumeSeries {
  data: string
  mensagens: number
  ofertas: number
  vagasExtraidas: number
  vagasImportadas: number
}

/**
 * Response da API de pipeline
 */
export interface MarketPipelineResponse {
  periodo: {
    inicio: string
    fim: string
  }

  funil: PipelineFunnelStep[]

  taxas: {
    deteccaoOferta: number
    extracao: number
    importacao: number
    descarte: number
    duplicatas: number
  }

  qualidade: {
    confiancaClassificacao: number
    confiancaExtracao: number
  }

  updatedAt: string
}

/**
 * Etapa do funil do pipeline
 */
export interface PipelineFunnelStep {
  id: string
  nome: string
  valor: number
  percentual: number        // em relacao ao total inicial
  percentualAnterior: number // em relacao a etapa anterior
  cor: string               // cor para visualizacao
}

/**
 * Response da API de ranking de grupos
 */
export interface GroupsRankingResponse {
  grupos: GrupoRanking[]
  total: number
  limit: number
  offset: number
  updatedAt: string
}

// =============================================================================
// COMPONENTES
// =============================================================================

/**
 * Props para KPICard
 */
export interface KPICardProps {
  titulo: string
  valor: string | number
  valorFormatado?: string
  subtitulo?: string
  icone: React.ReactNode
  variacao?: number | null
  variacaoTipo?: 'up' | 'down' | 'stable' | null
  tendencia?: number[]
  status?: 'success' | 'warning' | 'danger' | 'neutral'
  loading?: boolean
  className?: string
}

/**
 * Props para VolumeChart
 */
export interface VolumeChartProps {
  dados: VolumeSeries[]
  periodo: AnalyticsPeriod
  loading?: boolean
  altura?: number
  mostrarLegenda?: boolean
  seriesVisiveis?: ('mensagens' | 'ofertas' | 'vagasExtraidas' | 'vagasImportadas')[]
  className?: string
}

/**
 * Props para PipelineFunnel
 */
export interface PipelineFunnelProps {
  etapas: PipelineFunnelStep[]
  loading?: boolean
  orientacao?: 'horizontal' | 'vertical'
  mostrarPercentuais?: boolean
  className?: string
}

/**
 * Props para GroupsRanking
 */
export interface GroupsRankingProps {
  grupos: GrupoRanking[]
  total: number
  loading?: boolean
  onLoadMore?: () => void
  onGroupClick?: (grupo: GrupoRanking) => void
  className?: string
}

// =============================================================================
// TYPE GUARDS
// =============================================================================

/**
 * Verifica se o valor e um AnalyticsPeriod valido
 */
export function isAnalyticsPeriod(value: unknown): value is AnalyticsPeriod {
  return (
    typeof value === 'string' &&
    ['7d', '30d', '90d', 'custom'].includes(value)
  )
}

/**
 * Verifica se o valor e um VagaGroupStatus valido
 */
export function isVagaGroupStatus(value: unknown): value is VagaGroupStatus {
  return (
    typeof value === 'string' &&
    ['pendente', 'processando', 'importada', 'revisao', 'descartada', 'duplicada'].includes(value)
  )
}

/**
 * Verifica se o objeto e uma KPIMetric valida
 */
export function isKPIMetric(obj: unknown): obj is KPIMetric {
  if (typeof obj !== 'object' || obj === null) return false
  const metric = obj as Record<string, unknown>
  return (
    typeof metric.valor === 'number' &&
    typeof metric.valorFormatado === 'string' &&
    Array.isArray(metric.tendencia)
  )
}

// =============================================================================
// UTILITARIOS
// =============================================================================

/**
 * Converte snake_case do banco para camelCase
 */
export type SnakeToCamelCase<S extends string> =
  S extends `${infer T}_${infer U}`
    ? `${T}${Capitalize<SnakeToCamelCase<U>>}`
    : S

/**
 * Converte todas as keys de um objeto de snake_case para camelCase
 */
export type KeysToCamelCase<T> = {
  [K in keyof T as SnakeToCamelCase<string & K>]: T[K] extends object
    ? KeysToCamelCase<T[K]>
    : T[K]
}

/**
 * Tipo para resposta de API com erro
 */
export interface APIError {
  error: string
  message: string
  details?: Record<string, unknown>
}

/**
 * Tipo para resposta de API generica
 */
export type APIResponse<T> = T | APIError

/**
 * Type guard para verificar se e um erro de API
 */
export function isAPIError(response: unknown): response is APIError {
  if (typeof response !== 'object' || response === null) return false
  const obj = response as Record<string, unknown>
  return typeof obj.error === 'string' && typeof obj.message === 'string'
}
```

---

## Definition of Done (DoD)

### Checklist Obrigatorio

- [ ] Arquivo criado em `dashboard/types/market-intelligence.ts`
- [ ] Todos os tipos exportados
- [ ] Zero uso de `any`
- [ ] Todos os type guards implementados
- [ ] JSDoc em todos os tipos publicos
- [ ] Arquivo compila sem erros (`npm run type-check`)
- [ ] Testes de tipo passam

### Testes Obrigatorios

#### Arquivo de Teste: `dashboard/__tests__/types/market-intelligence.test.ts`

```typescript
/**
 * Testes para tipos de Market Intelligence
 */

import {
  isAnalyticsPeriod,
  isVagaGroupStatus,
  isKPIMetric,
  isAPIError,
  type AnalyticsPeriod,
  type VagaGroupStatus,
  type KPIMetric,
  type MarketOverviewResponse,
} from '@/types/market-intelligence'

describe('Market Intelligence Types', () => {
  describe('isAnalyticsPeriod', () => {
    it('deve retornar true para periodos validos', () => {
      expect(isAnalyticsPeriod('7d')).toBe(true)
      expect(isAnalyticsPeriod('30d')).toBe(true)
      expect(isAnalyticsPeriod('90d')).toBe(true)
      expect(isAnalyticsPeriod('custom')).toBe(true)
    })

    it('deve retornar false para valores invalidos', () => {
      expect(isAnalyticsPeriod('1d')).toBe(false)
      expect(isAnalyticsPeriod('invalid')).toBe(false)
      expect(isAnalyticsPeriod(null)).toBe(false)
      expect(isAnalyticsPeriod(undefined)).toBe(false)
      expect(isAnalyticsPeriod(123)).toBe(false)
      expect(isAnalyticsPeriod({})).toBe(false)
    })
  })

  describe('isVagaGroupStatus', () => {
    it('deve retornar true para status validos', () => {
      expect(isVagaGroupStatus('pendente')).toBe(true)
      expect(isVagaGroupStatus('processando')).toBe(true)
      expect(isVagaGroupStatus('importada')).toBe(true)
      expect(isVagaGroupStatus('revisao')).toBe(true)
      expect(isVagaGroupStatus('descartada')).toBe(true)
      expect(isVagaGroupStatus('duplicada')).toBe(true)
    })

    it('deve retornar false para valores invalidos', () => {
      expect(isVagaGroupStatus('ativa')).toBe(false)
      expect(isVagaGroupStatus('')).toBe(false)
      expect(isVagaGroupStatus(null)).toBe(false)
    })
  })

  describe('isKPIMetric', () => {
    it('deve retornar true para KPIMetric valida', () => {
      const validMetric: KPIMetric = {
        valor: 100,
        valorFormatado: '100',
        variacao: 10,
        variacaoTipo: 'up',
        tendencia: [90, 95, 100],
      }
      expect(isKPIMetric(validMetric)).toBe(true)
    })

    it('deve retornar true para KPIMetric com valores null', () => {
      const metricWithNulls: KPIMetric = {
        valor: 50,
        valorFormatado: '50',
        variacao: null,
        variacaoTipo: null,
        tendencia: [],
      }
      expect(isKPIMetric(metricWithNulls)).toBe(true)
    })

    it('deve retornar false para objetos invalidos', () => {
      expect(isKPIMetric(null)).toBe(false)
      expect(isKPIMetric(undefined)).toBe(false)
      expect(isKPIMetric({})).toBe(false)
      expect(isKPIMetric({ valor: '100' })).toBe(false) // valor deve ser number
      expect(isKPIMetric({ valor: 100, valorFormatado: 100 })).toBe(false) // valorFormatado deve ser string
    })
  })

  describe('isAPIError', () => {
    it('deve retornar true para erro de API valido', () => {
      const error = {
        error: 'VALIDATION_ERROR',
        message: 'Periodo invalido',
      }
      expect(isAPIError(error)).toBe(true)
    })

    it('deve retornar true para erro com details', () => {
      const error = {
        error: 'VALIDATION_ERROR',
        message: 'Campos invalidos',
        details: { field: 'period', reason: 'required' },
      }
      expect(isAPIError(error)).toBe(true)
    })

    it('deve retornar false para objetos que nao sao erro', () => {
      expect(isAPIError(null)).toBe(false)
      expect(isAPIError({ data: 'success' })).toBe(false)
      expect(isAPIError({ error: 123 })).toBe(false)
    })
  })

  describe('Type Inference', () => {
    it('deve permitir criar MarketOverviewResponse tipado', () => {
      const response: MarketOverviewResponse = {
        periodo: {
          inicio: '2024-01-01',
          fim: '2024-01-31',
          dias: 31,
        },
        kpis: {
          gruposAtivos: {
            valor: 50,
            valorFormatado: '50',
            variacao: 10,
            variacaoTipo: 'up',
            tendencia: [45, 47, 50],
          },
          vagasPorDia: {
            valor: 25,
            valorFormatado: '25/dia',
            variacao: -5,
            variacaoTipo: 'down',
            tendencia: [30, 28, 25],
          },
          taxaConversao: {
            valor: 0.65,
            valorFormatado: '65%',
            variacao: 2,
            variacaoTipo: 'up',
            tendencia: [0.60, 0.63, 0.65],
          },
          valorMedio: {
            valor: 150000,
            valorFormatado: 'R$ 1.500',
            variacao: null,
            variacaoTipo: null,
            tendencia: [],
          },
        },
        resumo: {
          totalMensagens: 5000,
          totalOfertas: 500,
          totalVagasExtraidas: 400,
          totalVagasImportadas: 260,
        },
        updatedAt: '2024-01-31T12:00:00Z',
      }

      // Se compilar, o teste passou
      expect(response.kpis.gruposAtivos.valor).toBe(50)
    })
  })
})
```

#### Comandos de Verificacao

```bash
# Type check
npm run type-check

# Rodar testes de tipo
npm run test -- __tests__/types/market-intelligence.test.ts --coverage

# Verificar cobertura (deve ser >= 80%)
npm run test -- __tests__/types/market-intelligence.test.ts --coverage --coverageThreshold='{"global":{"lines":80}}'
```

---

## Criterios de Aceitacao

| ID | Criterio | Verificacao |
|----|----------|-------------|
| AC1 | Arquivo existe | `ls dashboard/types/market-intelligence.ts` |
| AC2 | Zero any | `grep -c "any" dashboard/types/market-intelligence.ts` retorna 0 |
| AC3 | Type check passa | `npm run type-check` sem erros |
| AC4 | Testes passam | `npm run test` sem falhas |
| AC5 | Cobertura >= 80% | Coverage report mostra >= 80% |
| AC6 | JSDoc presente | Todos os tipos exportados tem JSDoc |

---

## Notas para o Desenvolvedor

1. **Convencao de nomes**:
   - Interfaces: PascalCase (ex: `MarketOverviewResponse`)
   - Types: PascalCase (ex: `AnalyticsPeriod`)
   - Type guards: camelCase com prefixo `is` (ex: `isAnalyticsPeriod`)

2. **Valores monetarios**: Sempre em centavos (integer) para evitar floating point

3. **Datas**: Sempre ISO string para serializacao JSON

4. **Type guards**: Fundamentais para validacao em runtime de dados externos

5. **Nao usar `any`**: Use `unknown` + type guard quando tipo e incerto
