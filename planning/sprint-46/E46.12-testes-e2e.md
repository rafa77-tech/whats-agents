# E46.12 - Testes E2E

## Resumo

Criar testes End-to-End que validam o fluxo completo do modulo de Market Intelligence, desde a navegacao ate a interacao com os componentes.

## Contexto

Os testes E2E garantem que todos os componentes funcionam em conjunto corretamente, simulando interacoes reais do usuario com a aplicacao.

## Escopo

### Incluido
- Testes de navegacao ate a aba Analytics
- Testes de interacao com PeriodSelector
- Testes de visualizacao dos componentes
- Testes de refresh de dados
- Testes de estados de erro
- Testes de responsividade

### Excluido
- Testes de performance detalhados (sera sprint futura)
- Testes de integracao com banco real

---

## Especificacao Tecnica

### Framework

- Playwright para testes E2E
- MSW (Mock Service Worker) para mock de APIs

### Cenarios de Teste

1. **Navegacao**
   - Navegar para /chips
   - Selecionar tab Grupos
   - Verificar que aba Analytics existe

2. **Visualizacao**
   - KPI cards renderizam com valores
   - VolumeChart renderiza grafico
   - PipelineFunnel renderiza barras
   - GroupsRanking renderiza tabela

3. **Interacao**
   - Mudar periodo atualiza dados
   - Clicar refresh recarrega dados
   - Toggle de series no grafico

4. **Estados**
   - Loading state exibido corretamente
   - Error state com retry funciona

---

## Implementacao

### Arquivo: `dashboard/e2e/market-intelligence.spec.ts`

```typescript
/**
 * Testes E2E - Market Intelligence
 * Sprint 46
 */

import { test, expect, Page } from '@playwright/test'

// =============================================================================
// CONSTANTS
// =============================================================================

const BASE_URL = process.env.PLAYWRIGHT_TEST_BASE_URL || 'http://localhost:3000'
const ANALYTICS_URL = `${BASE_URL}/chips?tab=grupos`

// =============================================================================
// HELPERS
// =============================================================================

async function navigateToAnalytics(page: Page) {
  await page.goto(ANALYTICS_URL)
  await page.waitForLoadState('networkidle')
}

async function waitForDataLoad(page: Page) {
  // Aguardar que loading desapareca
  await page.waitForSelector('[data-testid="kpi-card"]', { timeout: 10000 })
}

// =============================================================================
// MOCKS
// =============================================================================

const mockOverviewResponse = {
  periodo: { inicio: '2024-01-01', fim: '2024-01-31', dias: 31 },
  kpis: {
    gruposAtivos: { valor: 50, valorFormatado: '50', variacao: 10, variacaoTipo: 'up', tendencia: [45, 50] },
    vagasPorDia: { valor: 8.5, valorFormatado: '8.5/dia', variacao: 5, variacaoTipo: 'up', tendencia: [8, 8.5] },
    taxaConversao: { valor: 65, valorFormatado: '65%', variacao: -2, variacaoTipo: 'down', tendencia: [67, 65] },
    valorMedio: { valor: 1500, valorFormatado: 'R$ 1.500', variacao: null, variacaoTipo: null, tendencia: [1500] },
  },
  resumo: { totalMensagens: 5000, totalOfertas: 500, totalVagasExtraidas: 400, totalVagasImportadas: 260 },
  updatedAt: new Date().toISOString(),
}

const mockVolumeResponse = {
  periodo: { inicio: '2024-01-01', fim: '2024-01-31', dias: 31 },
  dados: [
    { data: '2024-01-01', mensagens: 150, ofertas: 45, vagasExtraidas: 30, vagasImportadas: 22 },
    { data: '2024-01-02', mensagens: 180, ofertas: 52, vagasExtraidas: 38, vagasImportadas: 28 },
    { data: '2024-01-03', mensagens: 160, ofertas: 48, vagasExtraidas: 35, vagasImportadas: 25 },
  ],
  totais: { mensagens: 490, ofertas: 145, vagasExtraidas: 103, vagasImportadas: 75 },
  medias: { mensagensPorDia: 163.3, ofertasPorDia: 48.3, vagasExtraidasPorDia: 34.3, vagasImportadasPorDia: 25 },
  updatedAt: new Date().toISOString(),
}

const mockPipelineResponse = {
  periodo: { inicio: '2024-01-01', fim: '2024-01-31', dias: 31 },
  funil: {
    etapas: [
      { id: 'mensagens', nome: 'Mensagens Recebidas', valor: 5000, percentual: 100 },
      { id: 'heuristica', nome: 'Passou Heuristica', valor: 2000, percentual: 40 },
      { id: 'ofertas', nome: 'Classificadas como Oferta', valor: 1500, percentual: 30 },
      { id: 'extraidas', nome: 'Vagas Extraidas', valor: 1100, percentual: 22 },
      { id: 'validadas', nome: 'Dados Minimos OK', valor: 950, percentual: 19 },
      { id: 'importadas', nome: 'Vagas Importadas', valor: 850, percentual: 17 },
    ],
    conversoes: {
      mensagemParaOferta: 30.0,
      ofertaParaExtracao: 73.3,
      extracaoParaImportacao: 77.3,
      totalPipeline: 17.0,
    },
  },
  perdas: { duplicadas: 150, descartadas: 100, revisao: 50, semDadosMinimos: 150 },
  qualidade: { confiancaClassificacaoMedia: 0.87, confiancaExtracaoMedia: 0.82 },
  updatedAt: new Date().toISOString(),
}

// =============================================================================
// TEST SETUP
// =============================================================================

test.beforeEach(async ({ page }) => {
  // Interceptar APIs e retornar mocks
  await page.route('**/api/market-intelligence/overview**', async (route) => {
    await route.fulfill({
      status: 200,
      contentType: 'application/json',
      body: JSON.stringify(mockOverviewResponse),
    })
  })

  await page.route('**/api/market-intelligence/volume**', async (route) => {
    await route.fulfill({
      status: 200,
      contentType: 'application/json',
      body: JSON.stringify(mockVolumeResponse),
    })
  })

  await page.route('**/api/market-intelligence/pipeline**', async (route) => {
    await route.fulfill({
      status: 200,
      contentType: 'application/json',
      body: JSON.stringify(mockPipelineResponse),
    })
  })
})

// =============================================================================
// NAVIGATION TESTS
// =============================================================================

test.describe('Navegacao', () => {
  test('deve navegar para a pagina de chips', async ({ page }) => {
    await page.goto(`${BASE_URL}/chips`)
    await page.waitForLoadState('networkidle')

    await expect(page).toHaveURL(/\/chips/)
  })

  test('deve acessar tab de grupos', async ({ page }) => {
    await page.goto(`${BASE_URL}/chips?tab=grupos`)
    await page.waitForLoadState('networkidle')

    await expect(page).toHaveURL(/tab=grupos/)
  })

  test('deve mostrar aba Analytics dentro de Grupos', async ({ page }) => {
    await navigateToAnalytics(page)

    // Verificar que conteudo de analytics esta presente
    await expect(page.getByRole('combobox')).toBeVisible() // PeriodSelector
  })
})

// =============================================================================
// VISUALIZATION TESTS
// =============================================================================

test.describe('Visualizacao de Componentes', () => {
  test('deve exibir 4 KPI cards', async ({ page }) => {
    await navigateToAnalytics(page)
    await waitForDataLoad(page)

    const kpiCards = page.locator('[data-testid="kpi-card"]')
    await expect(kpiCards).toHaveCount(4)
  })

  test('deve exibir valores corretos nos KPIs', async ({ page }) => {
    await navigateToAnalytics(page)
    await waitForDataLoad(page)

    await expect(page.getByText('50')).toBeVisible() // Grupos Ativos
    await expect(page.getByText('8.5/dia')).toBeVisible() // Vagas/Dia
    await expect(page.getByText('65%')).toBeVisible() // Taxa
    await expect(page.getByText('R$ 1.500')).toBeVisible() // Valor
  })

  test('deve exibir grafico de volume', async ({ page }) => {
    await navigateToAnalytics(page)
    await waitForDataLoad(page)

    const volumeChart = page.locator('[data-testid="volume-chart"]')
    await expect(volumeChart).toBeVisible()
  })

  test('deve exibir funil do pipeline', async ({ page }) => {
    await navigateToAnalytics(page)
    await waitForDataLoad(page)

    const funnel = page.locator('[data-testid="pipeline-funnel"]')
    await expect(funnel.first()).toBeVisible()
  })

  test('deve exibir todas as etapas do funil', async ({ page }) => {
    await navigateToAnalytics(page)
    await waitForDataLoad(page)

    await expect(page.getByText('Mensagens Recebidas')).toBeVisible()
    await expect(page.getByText('Passou Heuristica')).toBeVisible()
    await expect(page.getByText('Classificadas como Oferta')).toBeVisible()
    await expect(page.getByText('Vagas Extraidas')).toBeVisible()
    await expect(page.getByText('Dados Minimos OK')).toBeVisible()
    await expect(page.getByText('Vagas Importadas')).toBeVisible()
  })

  test('deve exibir ranking de grupos', async ({ page }) => {
    await navigateToAnalytics(page)
    await waitForDataLoad(page)

    const ranking = page.locator('[data-testid="groups-ranking"]')
    await expect(ranking).toBeVisible()
  })
})

// =============================================================================
// INTERACTION TESTS
// =============================================================================

test.describe('Interacoes', () => {
  test('deve mudar periodo ao selecionar no dropdown', async ({ page }) => {
    await navigateToAnalytics(page)
    await waitForDataLoad(page)

    // Abrir seletor de periodo
    const periodSelector = page.getByRole('combobox')
    await periodSelector.click()

    // Selecionar 7 dias
    await page.getByText('Ultimos 7 dias').click()

    // Verificar que API foi chamada com novo periodo
    // (o mock ja retorna os mesmos dados, mas a URL muda)
    await expect(page).toHaveURL(/period=7d|tab=grupos/)
  })

  test('deve atualizar dados ao clicar em refresh', async ({ page }) => {
    await navigateToAnalytics(page)
    await waitForDataLoad(page)

    // Clicar no botao de refresh
    const refreshBtn = page.getByRole('button', { name: /atualizar/i })
    await refreshBtn.click()

    // Verificar que botao muda para "Atualizando..."
    await expect(page.getByText('Atualizando...')).toBeVisible()

    // Aguardar voltar ao normal
    await expect(page.getByRole('button', { name: /atualizar/i })).toBeVisible()
  })

  test('deve toggle series no grafico de volume', async ({ page }) => {
    await navigateToAnalytics(page)
    await waitForDataLoad(page)

    // Encontrar botao de legenda (Mensagens)
    const legendBtn = page.getByRole('button', { name: /mensagens/i })
    await expect(legendBtn).toBeVisible()

    // Clicar para toggle
    await legendBtn.click()

    // Verificar que aria-pressed mudou
    await expect(legendBtn).toHaveAttribute('aria-pressed', 'false')
  })

  test('deve ordenar ranking ao clicar no header', async ({ page }) => {
    await navigateToAnalytics(page)
    await waitForDataLoad(page)

    // Clicar no header de Score
    const scoreHeader = page.getByRole('button', { name: /score/i })
    await scoreHeader.click()

    // Verificar que aparece seta de ordenacao
    // (o icone muda de ArrowUpDown para ArrowUp/ArrowDown)
    await expect(scoreHeader.locator('svg')).toBeVisible()
  })
})

// =============================================================================
// STATE TESTS
// =============================================================================

test.describe('Estados', () => {
  test('deve mostrar loading durante carregamento inicial', async ({ page }) => {
    // Adicionar delay no mock para ver loading
    await page.route('**/api/market-intelligence/**', async (route) => {
      await new Promise((resolve) => setTimeout(resolve, 500))
      await route.fulfill({
        status: 200,
        contentType: 'application/json',
        body: JSON.stringify(mockOverviewResponse),
      })
    })

    await page.goto(ANALYTICS_URL)

    // Verificar que loading esta visivel
    // (Skeletons ou indicador de loading)
    const loadingIndicator = page.locator('[class*="animate-pulse"], [class*="skeleton"]')
    await expect(loadingIndicator.first()).toBeVisible()

    // Aguardar dados carregarem
    await waitForDataLoad(page)
  })

  test('deve mostrar erro quando API falha', async ({ page }) => {
    // Mock de erro
    await page.route('**/api/market-intelligence/overview**', async (route) => {
      await route.fulfill({
        status: 500,
        contentType: 'application/json',
        body: JSON.stringify({ error: 'INTERNAL_ERROR', message: 'Erro de teste' }),
      })
    })

    await page.goto(ANALYTICS_URL)
    await page.waitForLoadState('networkidle')

    // Verificar mensagem de erro
    await expect(page.getByText(/erro ao carregar dados/i)).toBeVisible()
  })

  test('deve ter botao de retry no estado de erro', async ({ page }) => {
    await page.route('**/api/market-intelligence/overview**', async (route) => {
      await route.fulfill({ status: 500 })
    })

    await page.goto(ANALYTICS_URL)
    await page.waitForLoadState('networkidle')

    const retryBtn = page.getByRole('button', { name: /tentar novamente/i })
    await expect(retryBtn).toBeVisible()
  })

  test('retry deve tentar carregar dados novamente', async ({ page }) => {
    let callCount = 0

    await page.route('**/api/market-intelligence/overview**', async (route) => {
      callCount++
      if (callCount === 1) {
        await route.fulfill({ status: 500 })
      } else {
        await route.fulfill({
          status: 200,
          contentType: 'application/json',
          body: JSON.stringify(mockOverviewResponse),
        })
      }
    })

    await page.goto(ANALYTICS_URL)
    await page.waitForLoadState('networkidle')

    // Clicar em retry
    const retryBtn = page.getByRole('button', { name: /tentar novamente/i })
    await retryBtn.click()

    // Agora deve carregar
    await waitForDataLoad(page)
    await expect(page.locator('[data-testid="kpi-card"]').first()).toBeVisible()
  })
})

// =============================================================================
// RESPONSIVE TESTS
// =============================================================================

test.describe('Responsividade', () => {
  test('deve funcionar em viewport mobile', async ({ page }) => {
    await page.setViewportSize({ width: 375, height: 667 }) // iPhone SE

    await navigateToAnalytics(page)
    await waitForDataLoad(page)

    // KPIs devem estar em coluna unica
    const kpiCards = page.locator('[data-testid="kpi-card"]')
    await expect(kpiCards).toHaveCount(4)
  })

  test('deve funcionar em viewport tablet', async ({ page }) => {
    await page.setViewportSize({ width: 768, height: 1024 }) // iPad

    await navigateToAnalytics(page)
    await waitForDataLoad(page)

    // Componentes devem estar visiveis
    await expect(page.locator('[data-testid="volume-chart"]')).toBeVisible()
  })

  test('deve funcionar em viewport desktop', async ({ page }) => {
    await page.setViewportSize({ width: 1920, height: 1080 })

    await navigateToAnalytics(page)
    await waitForDataLoad(page)

    // Todos os componentes visiveis
    await expect(page.locator('[data-testid="kpi-card"]').first()).toBeVisible()
    await expect(page.locator('[data-testid="volume-chart"]')).toBeVisible()
    await expect(page.locator('[data-testid="pipeline-funnel"]').first()).toBeVisible()
    await expect(page.locator('[data-testid="groups-ranking"]')).toBeVisible()
  })
})

// =============================================================================
// ACCESSIBILITY TESTS
// =============================================================================

test.describe('Acessibilidade', () => {
  test('deve ter estrutura semantica correta', async ({ page }) => {
    await navigateToAnalytics(page)
    await waitForDataLoad(page)

    // Verificar que ha headings
    const headings = page.locator('h1, h2, h3, h4, h5, h6')
    await expect(headings.first()).toBeVisible()
  })

  test('deve ter labels em inputs', async ({ page }) => {
    await navigateToAnalytics(page)
    await waitForDataLoad(page)

    // Period selector deve ter role combobox
    const combobox = page.getByRole('combobox')
    await expect(combobox).toBeVisible()
  })

  test('botoes devem ter nomes acessiveis', async ({ page }) => {
    await navigateToAnalytics(page)
    await waitForDataLoad(page)

    // Refresh button
    const refreshBtn = page.getByRole('button', { name: /atualizar/i })
    await expect(refreshBtn).toBeVisible()

    // Sort buttons
    const sortBtns = page.getByRole('button', { name: /score|vagas|valor/i })
    await expect(sortBtns.first()).toBeVisible()
  })
})
```

---

## Configuracao Playwright

### Arquivo: `dashboard/playwright.config.ts`

```typescript
import { defineConfig, devices } from '@playwright/test'

export default defineConfig({
  testDir: './e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',

  use: {
    baseURL: process.env.PLAYWRIGHT_TEST_BASE_URL || 'http://localhost:3000',
    trace: 'on-first-retry',
    screenshot: 'only-on-failure',
  },

  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
    {
      name: 'firefox',
      use: { ...devices['Desktop Firefox'] },
    },
    {
      name: 'webkit',
      use: { ...devices['Desktop Safari'] },
    },
    {
      name: 'Mobile Chrome',
      use: { ...devices['Pixel 5'] },
    },
    {
      name: 'Mobile Safari',
      use: { ...devices['iPhone 12'] },
    },
  ],

  webServer: {
    command: 'npm run dev',
    url: 'http://localhost:3000',
    reuseExistingServer: !process.env.CI,
  },
})
```

---

## Definition of Done (DoD)

### Checklist Obrigatorio

- [ ] Arquivo `e2e/market-intelligence.spec.ts` criado
- [ ] Testes de navegacao passam
- [ ] Testes de visualizacao passam
- [ ] Testes de interacao passam
- [ ] Testes de estados passam
- [ ] Testes de responsividade passam
- [ ] Testes de acessibilidade passam
- [ ] Playwright configurado
- [ ] CI/CD atualizado para rodar E2E
- [ ] Todos os testes passam localmente
- [ ] Todos os testes passam no CI

### Comandos de Verificacao

```bash
# Instalar Playwright
npx playwright install

# Rodar todos os testes E2E
npx playwright test

# Rodar com UI
npx playwright test --ui

# Rodar teste especifico
npx playwright test market-intelligence

# Ver relatorio
npx playwright show-report

# Gerar traces para debug
npx playwright test --trace on
```

---

## Criterios de Aceitacao

| ID | Criterio | Verificacao |
|----|----------|-------------|
| AC1 | Setup Playwright | Configuracao funciona |
| AC2 | Navegacao | Testes passam |
| AC3 | Visualizacao | Testes passam |
| AC4 | Interacao | Testes passam |
| AC5 | Estados | Testes passam |
| AC6 | Responsividade | Mobile/Tablet/Desktop |
| AC7 | Acessibilidade | Testes passam |
| AC8 | CI integrado | Pipeline roda E2E |
| AC9 | 100% passing | Todos testes verdes |
| AC10 | Relatorio | HTML report gerado |

---

## Integracao CI/CD

Adicionar ao `.github/workflows/dashboard-ci.yml`:

```yaml
e2e-tests:
  runs-on: ubuntu-latest
  needs: build
  steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: dashboard/package-lock.json

    - name: Install dependencies
      run: npm ci
      working-directory: dashboard

    - name: Install Playwright Browsers
      run: npx playwright install --with-deps
      working-directory: dashboard

    - name: Run E2E tests
      run: npx playwright test
      working-directory: dashboard

    - name: Upload Playwright Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report
        path: dashboard/playwright-report/
        retention-days: 7
```

---

## Notas para o Desenvolvedor

1. **Mocks**: Usar route interception do Playwright para APIs
2. **Waits**: Sempre usar `waitForLoadState` ou waitFor explicito
3. **Seletores**: Preferir data-testid e roles para robustez
4. **Traces**: Habilitar em caso de flakiness para debug
5. **Parallel**: Testes sao paralelos, evitar estado compartilhado
6. **Screenshots**: Capturadas automaticamente em falhas
