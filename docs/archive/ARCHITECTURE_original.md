# Arquitetura do Sistema - Agente JÃºlia

## VisÃ£o Geral

JÃºlia Ã© uma escalista virtual autÃ´noma que prospecta mÃ©dicos, oferece plantÃµes, gerencia relacionamentos e fecha vagas - tudo via WhatsApp, com supervisÃ£o humana opcional.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚                           ARQUITETURA GERAL                                 â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   MÃ©dicos   â”‚â”€â”€â”€â”€â–¶â”‚  WhatsApp   â”‚â”€â”€â”€â”€â–¶â”‚  Evolution  â”‚â”€â”€â”€â”€â–¶â”‚  FastAPI  â”‚ â”‚
â”‚  â”‚             â”‚â—€â”€â”€â”€â”€â”‚             â”‚â—€â”€â”€â”€â”€â”‚    API      â”‚â—€â”€â”€â”€â”€â”‚           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                     â”‚       â”‚
â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚
â”‚                      â”‚                                              â”‚       â”‚
â”‚                      â–¼                                              â–¼       â”‚
â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚               â”‚  Chatwoot   â”‚                              â”‚    Agente   â”‚  â”‚
â”‚               â”‚ (SupervisÃ£o â”‚                              â”‚    JÃºlia    â”‚  â”‚
â”‚               â”‚   Humana)   â”‚                              â”‚  (Claude)   â”‚  â”‚
â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                      â”‚                                            â”‚         â”‚
â”‚                      â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”‚
â”‚                      â”‚         â”‚                                  â”‚         â”‚
â”‚                      â–¼         â–¼                                  â–¼         â”‚
â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚               â”‚      Supabase       â”‚                    â”‚   Slack/    â”‚    â”‚
â”‚               â”‚  (PostgreSQL + API) â”‚                    â”‚  WhatsApp   â”‚    â”‚
â”‚               â”‚                     â”‚                    â”‚  (Gestor)   â”‚    â”‚
â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Componentes

### 1. Evolution API (WhatsApp Gateway)

**Responsabilidade:** Interface com WhatsApp Business

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            EVOLUTION API                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  â€¢ Gerencia conexÃ£o com WhatsApp        â”‚
â”‚  â€¢ Envia/recebe mensagens               â”‚
â”‚  â€¢ Suporta mÃºltiplas instÃ¢ncias (chips) â”‚
â”‚  â€¢ Webhooks para mensagens recebidas    â”‚
â”‚  â€¢ Indicadores de presenÃ§a (digitando)  â”‚
â”‚                                         â”‚
â”‚  Endpoints principais:                  â”‚
â”‚  POST /message/sendText/{instance}      â”‚
â”‚  POST /chat/sendPresence/{instance}     â”‚
â”‚  POST /chat/markMessageAsRead/{instance}â”‚
â”‚                                         â”‚
â”‚  Webhook events:                        â”‚
â”‚  â€¢ messages.upsert (nova mensagem)      â”‚
â”‚  â€¢ connection.update (status conexÃ£o)   â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ConfiguraÃ§Ã£o:**
- URL: `EVOLUTION_API_URL`
- API Key: `EVOLUTION_API_KEY`
- InstÃ¢ncia: `EVOLUTION_INSTANCE`

---

### 2. FastAPI (Servidor Principal)

**Responsabilidade:** Orquestra todo o fluxo

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         FASTAPI                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  WEBHOOKS                                                       â”‚
â”‚  â”œâ”€â”€ POST /webhook/evolution    â† Mensagens do WhatsApp         â”‚
â”‚  â””â”€â”€ POST /webhook/chatwoot     â† Eventos do Chatwoot           â”‚
â”‚                                                                 â”‚
â”‚  API DE GESTÃƒO                                                  â”‚
â”‚  â”œâ”€â”€ POST /api/enviar           â†’ Envio manual                  â”‚
â”‚  â”œâ”€â”€ POST /api/processar-notif  â†’ Dispara fila notificaÃ§Ãµes     â”‚
â”‚  â”œâ”€â”€ GET  /api/health           â†’ Health check                  â”‚
â”‚  â””â”€â”€ GET  /api/stats            â†’ EstatÃ­sticas                  â”‚
â”‚                                                                 â”‚
â”‚  FLUXO DE MENSAGEM RECEBIDA                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 1. Webhook Evolution recebe mensagem                     â”‚   â”‚
â”‚  â”‚ 2. Extrai telefone e conteÃºdo                           â”‚   â”‚
â”‚  â”‚ 3. Marca como lida (background)                         â”‚   â”‚
â”‚  â”‚ 4. Chama processar_mensagem_recebida (background)       â”‚   â”‚
â”‚  â”‚    â”œâ”€â”€ Mostra presenÃ§a online                           â”‚   â”‚
â”‚  â”‚    â”œâ”€â”€ Mostra "digitando"                               â”‚   â”‚
â”‚  â”‚    â”œâ”€â”€ Chama agente JÃºlia                               â”‚   â”‚
â”‚  â”‚    â”œâ”€â”€ Se resposta: envia via Evolution                 â”‚   â”‚
â”‚  â”‚    â””â”€â”€ Sincroniza com Chatwoot                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 3. Agente JÃºlia (Core)

**Responsabilidade:** CÃ©rebro da operaÃ§Ã£o - decide o que responder

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      AGENTE JÃšLIA                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  PERSONA                                                        â”‚
â”‚  â”œâ”€â”€ Nome: JÃºlia Mendes, 27 anos                               â”‚
â”‚  â”œâ”€â”€ Cargo: Escalista                                          â”‚
â”‚  â”œâ”€â”€ Tom: Informal, profissional, direto                       â”‚
â”‚  â””â”€â”€ Estilo: WhatsApp natural (vc, pra, tÃ¡, blz)              â”‚
â”‚                                                                 â”‚
â”‚  FLUXO DE PROCESSAMENTO                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  processar_mensagem(telefone, mensagem)                  â”‚   â”‚
â”‚  â”‚         â”‚                                                â”‚   â”‚
â”‚  â”‚         â–¼                                                â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚   â”‚
â”‚  â”‚  â”‚ Busca/cria   â”‚                                       â”‚   â”‚
â”‚  â”‚  â”‚ mÃ©dico       â”‚                                       â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚   â”‚
â”‚  â”‚         â–¼                                                â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚   â”‚
â”‚  â”‚  â”‚ Busca/cria   â”‚                                       â”‚   â”‚
â”‚  â”‚  â”‚ conversa     â”‚                                       â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚   â”‚
â”‚  â”‚         â–¼                                                â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚   â”‚
â”‚  â”‚  â”‚ controlled_  â”‚â”€NOâ”€â–¶â”‚ Salva msg,      â”‚               â”‚   â”‚
â”‚  â”‚  â”‚ by = 'ai'?   â”‚     â”‚ retorna None    â”‚               â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚   â”‚
â”‚  â”‚         â”‚ YES                                            â”‚   â”‚
â”‚  â”‚         â–¼                                                â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚   â”‚
â”‚  â”‚  â”‚ Salva msg    â”‚                                       â”‚   â”‚
â”‚  â”‚  â”‚ entrada      â”‚                                       â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚   â”‚
â”‚  â”‚         â–¼                                                â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚   â”‚
â”‚  â”‚  â”‚ Carrega      â”‚                                       â”‚   â”‚
â”‚  â”‚  â”‚ contexto:    â”‚                                       â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ Dados med. â”‚                                       â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ HistÃ³rico  â”‚                                       â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ MemÃ³ria    â”‚                                       â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ Vagas      â”‚                                       â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚   â”‚
â”‚  â”‚         â–¼                                                â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚   â”‚
â”‚  â”‚  â”‚ Monta prompt â”‚                                       â”‚   â”‚
â”‚  â”‚  â”‚ + histÃ³rico  â”‚                                       â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚   â”‚
â”‚  â”‚         â–¼                                                â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚   â”‚
â”‚  â”‚  â”‚ Chama LLM    â”‚â—€â”€â”€â”€â”€ Tools disponÃ­veis                â”‚   â”‚
â”‚  â”‚  â”‚ (Claude)     â”‚                                       â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚   â”‚
â”‚  â”‚         â–¼                                                â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚   â”‚
â”‚  â”‚  â”‚ Salva msg    â”‚                                       â”‚   â”‚
â”‚  â”‚  â”‚ saÃ­da        â”‚                                       â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚   â”‚
â”‚  â”‚         â–¼                                                â”‚   â”‚
â”‚  â”‚     Retorna resposta                                     â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  TOOLS DO AGENTE                                                â”‚
â”‚  â”œâ”€â”€ buscar_vagas          â†’ Consulta vagas_disponiveis        â”‚
â”‚  â”œâ”€â”€ reservar_plantao      â†’ Reserva vaga + notifica gestor    â”‚
â”‚  â”œâ”€â”€ atualizar_perfil      â†’ Atualiza dados do mÃ©dico          â”‚
â”‚  â”œâ”€â”€ salvar_memoria        â†’ Salva fato em doctor_context      â”‚
â”‚  â”œâ”€â”€ notificar_gestor      â†’ Cria notificaÃ§Ã£o Slack/WhatsApp   â”‚
â”‚  â””â”€â”€ transferir_para_humanoâ†’ Muda controlled_by + handoff      â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**System Prompt (resumido):**
```
VocÃª Ã© JÃºlia Mendes, escalista da {empresa}. 27 anos, 4 anos de experiÃªncia.
VocÃª Ã© uma pessoa real - nÃ£o um assistente, nÃ£o uma IA, nÃ£o um bot.

COMO ESCREVE:
- Mensagens curtas, quebra em vÃ¡rias
- Usa "vc", "pra", "tÃ¡", "blz"
- NUNCA bullet points ou linguagem corporativa
- Emoji com moderaÃ§Ã£o

REGRAS ABSOLUTAS:
1. NUNCA revele que Ã© IA
2. NUNCA liste informaÃ§Ãµes
3. Responda como pessoa ocupada mas atenciosa

CONHECIMENTO:
- Tipos de plantÃ£o, valores de mercado
- DocumentaÃ§Ã£o necessÃ¡ria
- Dores dos mÃ©dicos

CONTEXTO:
{memoria_medico}

VAGAS DISPONÃVEIS:
{vagas_disponiveis}
```

---

### 4. Chatwoot (SupervisÃ£o Humana)

**Responsabilidade:** Interface para humanos acompanharem e intervirem

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        CHATWOOT                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  FUNCIONALIDADES                                                â”‚
â”‚  â”œâ”€â”€ Visualiza todas as conversas em tempo real                â”‚
â”‚  â”œâ”€â”€ VÃª mensagens da JÃºlia e do mÃ©dico                         â”‚
â”‚  â”œâ”€â”€ Pode assumir conversa (label "humano")                    â”‚
â”‚  â”œâ”€â”€ Pode devolver pro bot (remove label)                      â”‚
â”‚  â””â”€â”€ Adiciona notas internas                                   â”‚
â”‚                                                                 â”‚
â”‚  INTEGRAÃ‡ÃƒO                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  SincronizaÃ§Ã£o de mensagens:                             â”‚   â”‚
â”‚  â”‚  â€¢ Toda msg do mÃ©dico â†’ aparece no Chatwoot             â”‚   â”‚
â”‚  â”‚  â€¢ Toda msg da JÃºlia â†’ aparece no Chatwoot              â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  Controle via Labels:                                    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚   â”‚
â”‚  â”‚  â”‚ Label        â”‚     AÃ§Ã£o no sistema                   â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚   â”‚
â”‚  â”‚  â”‚ "humano"     â”‚ â†’ controlled_by = 'human'             â”‚   â”‚
â”‚  â”‚  â”‚ (adicionar)  â”‚ â†’ JÃºlia para de responder             â”‚   â”‚
â”‚  â”‚  â”‚              â”‚ â†’ Registra handoff                    â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚   â”‚
â”‚  â”‚  â”‚ "humano"     â”‚ â†’ controlled_by = 'ai'                â”‚   â”‚
â”‚  â”‚  â”‚ (remover)    â”‚ â†’ JÃºlia volta a responder             â”‚   â”‚
â”‚  â”‚  â”‚              â”‚ â†’ Registra handoff                    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  WEBHOOK EVENTS                                                 â”‚
â”‚  â”œâ”€â”€ conversation_updated â†’ Detecta mudanÃ§a de labels          â”‚
â”‚  â””â”€â”€ message_created      â†’ Detecta msg do humano              â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Fluxo de Handoff:**
```
HUMANO QUER ASSUMIR                    HUMANO QUER DEVOLVER
        â”‚                                      â”‚
        â–¼                                      â–¼
Adiciona label "humano"              Remove label "humano"
        â”‚                                      â”‚
        â–¼                                      â–¼
Webhook dispara                       Webhook dispara
        â”‚                                      â”‚
        â–¼                                      â–¼
UPDATE conversations                  UPDATE conversations
SET controlled_by='human'             SET controlled_by='ai'
        â”‚                                      â”‚
        â–¼                                      â–¼
INSERT handoffs                       INSERT handoffs
(ai â†’ human)                          (human â†’ ai)
        â”‚                                      â”‚
        â–¼                                      â–¼
JÃºlia IGNORA mensagens               JÃºlia RESPONDE mensagens
```

---

### 5. Worker de CadÃªncia

**Responsabilidade:** Dispara mensagens de prospecÃ§Ã£o respeitando rate limits

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    WORKER DE CADÃŠNCIA                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  RATE LIMITS                                                    â”‚
â”‚  â”œâ”€â”€ max_por_hora: 20 mensagens                                â”‚
â”‚  â”œâ”€â”€ max_por_dia: 100 mensagens                                â”‚
â”‚  â”œâ”€â”€ intervalo_min: 45 segundos entre msgs                     â”‚
â”‚  â”œâ”€â”€ intervalo_max: 180 segundos (variaÃ§Ã£o humana)             â”‚
â”‚  â”œâ”€â”€ horÃ¡rio: 08:00 - 20:00                                    â”‚
â”‚  â””â”€â”€ dias: Segunda a Sexta                                     â”‚
â”‚                                                                 â”‚
â”‚  TIPOS DE ENVIO                                                 â”‚
â”‚  â”œâ”€â”€ abertura      â†’ Primeiro contato (msg Ãºnica gerada)       â”‚
â”‚  â”œâ”€â”€ follow_up_1   â†’ 48h sem resposta                          â”‚
â”‚  â”œâ”€â”€ follow_up_2   â†’ 5 dias sem resposta (com vaga)            â”‚
â”‚  â”œâ”€â”€ follow_up_3   â†’ 15 dias (Ãºltima tentativa)                â”‚
â”‚  â”œâ”€â”€ oferta_vaga   â†’ Vaga que combina com perfil               â”‚
â”‚  â””â”€â”€ reativacao    â†’ MÃ©dico inativo hÃ¡ 30+ dias                â”‚
â”‚                                                                 â”‚
â”‚  FLUXO                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  Loop infinito:                                          â”‚   â”‚
â”‚  â”‚         â”‚                                                â”‚   â”‚
â”‚  â”‚         â–¼                                                â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚   â”‚
â”‚  â”‚  â”‚ Limite hora  â”‚â”€SIMâ”€â–¶â”‚ Aguarda 60s    â”‚               â”‚   â”‚
â”‚  â”‚  â”‚ atingido?    â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚   â”‚
â”‚  â”‚         â”‚ NÃƒO                                            â”‚   â”‚
â”‚  â”‚         â–¼                                                â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚   â”‚
â”‚  â”‚  â”‚ Limite dia   â”‚â”€SIMâ”€â–¶â”‚ Aguarda prÃ³x.  â”‚               â”‚   â”‚
â”‚  â”‚  â”‚ atingido?    â”‚     â”‚ dia             â”‚               â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚   â”‚
â”‚  â”‚         â”‚ NÃƒO                                            â”‚   â”‚
â”‚  â”‚         â–¼                                                â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚   â”‚
â”‚  â”‚  â”‚ Dentro do    â”‚â”€NÃƒOâ”€â–¶â”‚ Aguarda 5min   â”‚               â”‚   â”‚
â”‚  â”‚  â”‚ horÃ¡rio?     â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚   â”‚
â”‚  â”‚         â”‚ SIM                                            â”‚   â”‚
â”‚  â”‚         â–¼                                                â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚   â”‚
â”‚  â”‚  â”‚ Busca fila   â”‚                                       â”‚   â”‚
â”‚  â”‚  â”‚ pendente     â”‚                                       â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚   â”‚
â”‚  â”‚         â–¼                                                â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚   â”‚
â”‚  â”‚  â”‚ Para cada    â”‚                                       â”‚   â”‚
â”‚  â”‚  â”‚ item:        â”‚                                       â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ Gera msg   â”‚                                       â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ Envia      â”‚                                       â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ Atualiza   â”‚                                       â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ Agenda     â”‚                                       â”‚   â”‚
â”‚  â”‚  â”‚   follow-up  â”‚                                       â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ Sleep      â”‚                                       â”‚   â”‚
â”‚  â”‚  â”‚   aleatÃ³rio  â”‚                                       â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  CADÃŠNCIA DE FOLLOW-UPS                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  Abertura â”€â”€(48h)â”€â”€â–¶ Follow-up 1                        â”‚   â”‚
â”‚  â”‚      â”‚                    â”‚                              â”‚   â”‚
â”‚  â”‚      â”‚               (sem resposta)                      â”‚   â”‚
â”‚  â”‚      â”‚                    â”‚                              â”‚   â”‚
â”‚  â”‚      â”‚               (5 dias)                            â”‚   â”‚
â”‚  â”‚      â”‚                    â–¼                              â”‚   â”‚
â”‚  â”‚      â”‚              Follow-up 2 (com vaga)               â”‚   â”‚
â”‚  â”‚      â”‚                    â”‚                              â”‚   â”‚
â”‚  â”‚      â”‚               (sem resposta)                      â”‚   â”‚
â”‚  â”‚      â”‚                    â”‚                              â”‚   â”‚
â”‚  â”‚      â”‚               (15 dias)                           â”‚   â”‚
â”‚  â”‚      â”‚                    â–¼                              â”‚   â”‚
â”‚  â”‚      â”‚              Follow-up 3 (Ãºltimo)                 â”‚   â”‚
â”‚  â”‚      â”‚                    â”‚                              â”‚   â”‚
â”‚  â”‚      â”‚               (sem resposta)                      â”‚   â”‚
â”‚  â”‚      â”‚                    â–¼                              â”‚   â”‚
â”‚  â”‚      â”‚              stage = 'nao_respondeu'              â”‚   â”‚
â”‚  â”‚      â”‚              (pausa 60 dias)                      â”‚   â”‚
â”‚  â”‚      â”‚                                                   â”‚   â”‚
â”‚  â”‚      â”‚                                                   â”‚   â”‚
â”‚  â”‚      â””â”€â”€(resposta)â”€â”€â–¶ JÃºlia assume conversa             â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 6. Sistema de NotificaÃ§Ãµes

**Responsabilidade:** Alertar gestor sobre eventos importantes

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      NOTIFICAÃ‡Ã•ES                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  TIPOS DE NOTIFICAÃ‡ÃƒO                                           â”‚
â”‚  â”œâ”€â”€ plantao_fechado      ğŸ‰ JÃºlia fechou um plantÃ£o           â”‚
â”‚  â”œâ”€â”€ medico_cadastrado    âœ… Novo mÃ©dico cadastrado            â”‚
â”‚  â”œâ”€â”€ intervencao_necessaria ğŸš¨ JÃºlia precisa de ajuda          â”‚
â”‚  â””â”€â”€ erro                 âŒ Algo deu errado                   â”‚
â”‚                                                                 â”‚
â”‚  CANAIS                                                         â”‚
â”‚  â”œâ”€â”€ Slack (webhook)                                           â”‚
â”‚  â””â”€â”€ WhatsApp (gestor)                                         â”‚
â”‚                                                                 â”‚
â”‚  FLUXO                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  Evento ocorre (ex: plantÃ£o fechado)                     â”‚   â”‚
â”‚  â”‚         â”‚                                                â”‚   â”‚
â”‚  â”‚         â–¼                                                â”‚   â”‚
â”‚  â”‚  INSERT notificacoes_gestor                              â”‚   â”‚
â”‚  â”‚  (tipo, titulo, mensagem, canal, destino)                â”‚   â”‚
â”‚  â”‚         â”‚                                                â”‚   â”‚
â”‚  â”‚         â–¼                                                â”‚   â”‚
â”‚  â”‚  Worker processa fila                                    â”‚   â”‚
â”‚  â”‚         â”‚                                                â”‚   â”‚
â”‚  â”‚         â”œâ”€â”€ Slack: POST webhook com blocks               â”‚   â”‚
â”‚  â”‚         â”‚                                                â”‚   â”‚
â”‚  â”‚         â””â”€â”€ WhatsApp: Envia via Evolution                â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  EXEMPLO SLACK (plantÃ£o fechado)                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ‰ PlantÃ£o fechado pela JÃºlia!                          â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚ *Dr. Carlos Silva* confirmou plantÃ£o no *Hospital XYZ*   â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚ *Data:* 15/12/2024                                       â”‚   â”‚
â”‚  â”‚ *Valor:* R$ 2.500                                        â”‚   â”‚
â”‚  â”‚ *Fechado por:* JÃºlia (IA)                                â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚ ğŸ“… 05/12/2024 14:32                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 7. Supabase (Banco de Dados)

**Responsabilidade:** PersistÃªncia e API

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        SUPABASE                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  POSTGRESQL                                                     â”‚
â”‚  â”œâ”€â”€ 19 tabelas (ver DATABASE.md)                              â”‚
â”‚  â”œâ”€â”€ Views (vagas_disponiveis)                                 â”‚
â”‚  â”œâ”€â”€ Ãndices otimizados                                        â”‚
â”‚  â”œâ”€â”€ RLS habilitado                                            â”‚
â”‚  â””â”€â”€ pgvector para embeddings                                  â”‚
â”‚                                                                 â”‚
â”‚  USOS NO SISTEMA                                                â”‚
â”‚  â”œâ”€â”€ MÃ©dicos e perfis                                          â”‚
â”‚  â”œâ”€â”€ Conversas e mensagens                                     â”‚
â”‚  â”œâ”€â”€ MemÃ³ria RAG (doctor_context)                              â”‚
â”‚  â”œâ”€â”€ Vagas e escala                                            â”‚
â”‚  â”œâ”€â”€ Fila de envios                                            â”‚
â”‚  â”œâ”€â”€ NotificaÃ§Ãµes                                              â”‚
â”‚  â””â”€â”€ Rate limiting (whatsapp_instances)                        â”‚
â”‚                                                                 â”‚
â”‚  BUSCA SEMÃ‚NTICA (RAG)                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  1. Mensagem do mÃ©dico chega                             â”‚   â”‚
â”‚  â”‚         â”‚                                                â”‚   â”‚
â”‚  â”‚         â–¼                                                â”‚   â”‚
â”‚  â”‚  2. Gera embedding da mensagem                           â”‚   â”‚
â”‚  â”‚         â”‚                                                â”‚   â”‚
â”‚  â”‚         â–¼                                                â”‚   â”‚
â”‚  â”‚  3. Busca chunks similares em doctor_context             â”‚   â”‚
â”‚  â”‚     SELECT content FROM doctor_context                   â”‚   â”‚
â”‚  â”‚     WHERE cliente_id = X                                 â”‚   â”‚
â”‚  â”‚     ORDER BY embedding <-> query_embedding               â”‚   â”‚
â”‚  â”‚     LIMIT 5                                              â”‚   â”‚
â”‚  â”‚         â”‚                                                â”‚   â”‚
â”‚  â”‚         â–¼                                                â”‚   â”‚
â”‚  â”‚  4. Inclui no contexto do prompt                         â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Fluxos Principais

### Fluxo 1: Mensagem Recebida

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     FLUXO: MENSAGEM RECEBIDA                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  MÃ©dico envia                                                               â”‚
â”‚  "Oi, tÃ´ procurando plantÃ£o"                                               â”‚
â”‚         â”‚                                                                   â”‚
â”‚         â–¼                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                           â”‚
â”‚  â”‚  WhatsApp   â”‚                                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                                           â”‚
â”‚         â”‚                                                                   â”‚
â”‚         â–¼                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                           â”‚
â”‚  â”‚ Evolution   â”‚â”€â”€webhookâ”€â”€â–¶ POST /webhook/evolution                       â”‚
â”‚  â”‚ API         â”‚                    â”‚                                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚                                      â”‚
â”‚                                     â–¼                                      â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚                              â”‚  FastAPI    â”‚                               â”‚
â”‚                              â”‚  extrai:    â”‚                               â”‚
â”‚                              â”‚  â€¢ telefone â”‚                               â”‚
â”‚                              â”‚  â€¢ conteudo â”‚                               â”‚
â”‚                              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚                                     â”‚                                      â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚                    â”‚                â”‚                â”‚                     â”‚
â”‚                    â–¼                â–¼                â–¼                     â”‚
â”‚             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚             â”‚ Marca     â”‚   â”‚ PresenÃ§a  â”‚   â”‚ Processa  â”‚                 â”‚
â”‚             â”‚ como lida â”‚   â”‚ online    â”‚   â”‚ mensagem  â”‚                 â”‚
â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                   â”‚                        â”‚
â”‚                                                   â–¼                        â”‚
â”‚                                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚                                            â”‚ Busca/cria  â”‚                 â”‚
â”‚                                            â”‚ mÃ©dico      â”‚                 â”‚
â”‚                                            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                   â”‚                        â”‚
â”‚                                                   â–¼                        â”‚
â”‚                                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚                                            â”‚ Busca/cria  â”‚                 â”‚
â”‚                                            â”‚ conversa    â”‚                 â”‚
â”‚                                            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                   â”‚                        â”‚
â”‚                                                   â–¼                        â”‚
â”‚                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚                                      â”‚ controlled_by = 'ai'? â”‚            â”‚
â”‚                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                  â”‚                         â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚                              â”‚ SIM                                NÃƒOâ”‚     â”‚
â”‚                              â–¼                                       â–¼     â”‚
â”‚                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚                       â”‚ Carrega     â”‚                        â”‚ Salva msg â”‚ â”‚
â”‚                       â”‚ contexto    â”‚                        â”‚ retorna   â”‚ â”‚
â”‚                       â”‚ completo    â”‚                        â”‚ None      â”‚ â”‚
â”‚                       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â”‚                                             â”‚
â”‚                              â–¼                                             â”‚
â”‚                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚                       â”‚ Monta       â”‚                                      â”‚
â”‚                       â”‚ prompt +    â”‚                                      â”‚
â”‚                       â”‚ histÃ³rico   â”‚                                      â”‚
â”‚                       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â”‚                              â”‚                                             â”‚
â”‚                              â–¼                                             â”‚
â”‚                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚                       â”‚ Claude API  â”‚                                      â”‚
â”‚                       â”‚ (com tools) â”‚                                      â”‚
â”‚                       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â”‚                              â”‚                                             â”‚
â”‚                              â–¼                                             â”‚
â”‚                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚                       â”‚ Executa     â”‚                                      â”‚
â”‚                       â”‚ tools se    â”‚                                      â”‚
â”‚                       â”‚ necessÃ¡rio  â”‚                                      â”‚
â”‚                       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â”‚                              â”‚                                             â”‚
â”‚                              â–¼                                             â”‚
â”‚                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚                       â”‚ Salva       â”‚                                      â”‚
â”‚                       â”‚ resposta    â”‚                                      â”‚
â”‚                       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â”‚                              â”‚                                             â”‚
â”‚                              â–¼                                             â”‚
â”‚                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚                       â”‚ Envia via   â”‚                                      â”‚
â”‚                       â”‚ Evolution   â”‚                                      â”‚
â”‚                       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â”‚                              â”‚                                             â”‚
â”‚                              â–¼                                             â”‚
â”‚                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚                       â”‚ Sincroniza  â”‚                                      â”‚
â”‚                       â”‚ Chatwoot    â”‚                                      â”‚
â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â”‚                                                                             â”‚
â”‚  MÃ©dico recebe                                                             â”‚
â”‚  "Oi! Tudo bem? Que bom que tÃ¡ procurando!                                 â”‚
â”‚   Qual sua especialidade?"                                                 â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Fluxo 2: Fechar PlantÃ£o

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     FLUXO: FECHAR PLANTÃƒO                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  MÃ©dico: "Quero esse plantÃ£o de sÃ¡bado"                                    â”‚
â”‚         â”‚                                                                   â”‚
â”‚         â–¼                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ JÃºlia processa e identifica intenÃ§Ã£o de fechar                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                   â”‚                                        â”‚
â”‚                                   â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Tool: reservar_plantao(vaga_id)                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                   â”‚                                        â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚                    â”‚                             â”‚                         â”‚
â”‚                    â–¼                             â–¼                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ UPDATE vagas                â”‚  â”‚ INSERT notificacoes_gestor  â”‚         â”‚
â”‚  â”‚ SET status='reservada',    â”‚  â”‚ tipo='plantao_fechado'      â”‚         â”‚
â”‚  â”‚     cliente_id=X,          â”‚  â”‚                             â”‚         â”‚
â”‚  â”‚     fechada_por='julia'    â”‚  â”‚                             â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                  â”‚                         â”‚
â”‚                                                  â–¼                         â”‚
â”‚                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚                                   â”‚ Worker envia notificaÃ§Ã£o    â”‚         â”‚
â”‚                                   â”‚ para Slack/WhatsApp         â”‚         â”‚
â”‚                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                            â”‚
â”‚  Gestor recebe no Slack:                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ‰ PlantÃ£o fechado pela JÃºlia!                                       â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚ Dr. Carlos Silva confirmou plantÃ£o no Hospital SÃ£o Luiz              â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚ Data: 07/12/2024 | Valor: R$ 2.500 | Fechado por: JÃºlia (IA)        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  MÃ©dico recebe:                                                            â”‚
â”‚  "Show, reservei pra vc! SÃ¡bado, Hospital SÃ£o Luiz, 07h-19h.              â”‚
â”‚   Vou precisar dos seus docs pra finalizar o cadastro, ok?"               â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Fluxo 3: Handoff para Humano

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     FLUXO: HANDOFF PARA HUMANO                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  CENÃRIO A: JÃºlia decide transferir                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                         â”‚
â”‚                                                                             â”‚
â”‚  MÃ©dico: "Isso Ã© um absurdo, vcs me devem dinheiro!"                       â”‚
â”‚         â”‚                                                                   â”‚
â”‚         â–¼                                                                   â”‚
â”‚  JÃºlia detecta: mÃ©dico irritado, situaÃ§Ã£o complexa                         â”‚
â”‚         â”‚                                                                   â”‚
â”‚         â–¼                                                                   â”‚
â”‚  Tool: transferir_para_humano("MÃ©dico irritado, possÃ­vel dÃ­vida")          â”‚
â”‚         â”‚                                                                   â”‚
â”‚         â”œâ”€â”€â–¶ UPDATE conversations SET controlled_by='human'                â”‚
â”‚         â”‚                                                                   â”‚
â”‚         â”œâ”€â”€â–¶ INSERT handoffs (ai â†’ human, reason)                          â”‚
â”‚         â”‚                                                                   â”‚
â”‚         â””â”€â”€â–¶ INSERT notificacoes_gestor tipo='intervencao_necessaria'      â”‚
â”‚                                                                             â”‚
â”‚  Gestor recebe alerta:                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸš¨ JÃºlia precisa de ajuda!                                           â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚ Conversa com Dr. Carlos precisa de atenÃ§Ã£o humana.                   â”‚   â”‚
â”‚  â”‚ Motivo: MÃ©dico irritado, possÃ­vel dÃ­vida                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  PrÃ³ximas mensagens do mÃ©dico: JÃºlia NÃƒO responde (humano assume)          â”‚
â”‚                                                                             â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                             â”‚
â”‚  CENÃRIO B: Humano assume via Chatwoot                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                     â”‚
â”‚                                                                             â”‚
â”‚  Humano vÃª conversa no Chatwoot                                            â”‚
â”‚         â”‚                                                                   â”‚
â”‚         â–¼                                                                   â”‚
â”‚  Adiciona label "humano"                                                   â”‚
â”‚         â”‚                                                                   â”‚
â”‚         â–¼                                                                   â”‚
â”‚  Chatwoot envia webhook â†’ POST /webhook/chatwoot                           â”‚
â”‚         â”‚                                                                   â”‚
â”‚         â–¼                                                                   â”‚
â”‚  Sistema detecta label "humano" adicionada                                 â”‚
â”‚         â”‚                                                                   â”‚
â”‚         â”œâ”€â”€â–¶ UPDATE conversations SET controlled_by='human'                â”‚
â”‚         â”‚                                                                   â”‚
â”‚         â””â”€â”€â–¶ INSERT handoffs (ai â†’ human, "Label via Chatwoot")            â”‚
â”‚                                                                             â”‚
â”‚  JÃºlia para de responder automaticamente                                   â”‚
â”‚                                                                             â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                             â”‚
â”‚  CENÃRIO C: Humano devolve para JÃºlia                                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                     â”‚
â”‚                                                                             â”‚
â”‚  Humano resolveu a situaÃ§Ã£o                                                â”‚
â”‚         â”‚                                                                   â”‚
â”‚         â–¼                                                                   â”‚
â”‚  Remove label "humano" no Chatwoot                                         â”‚
â”‚         â”‚                                                                   â”‚
â”‚         â–¼                                                                   â”‚
â”‚  Webhook dispara                                                           â”‚
â”‚         â”‚                                                                   â”‚
â”‚         â”œâ”€â”€â–¶ UPDATE conversations SET controlled_by='ai'                   â”‚
â”‚         â”‚                                                                   â”‚
â”‚         â””â”€â”€â–¶ INSERT handoffs (human â†’ ai, "Devolvido")                     â”‚
â”‚                                                                             â”‚
â”‚  JÃºlia volta a responder automaticamente                                   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Estrutura de Pastas

```
/julia-agent
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ main.py              # FastAPI + webhooks
â”‚   â”œâ”€â”€ agent.py             # Core do agente JÃºlia
â”‚   â”œâ”€â”€ database.py          # Supabase client + queries
â”‚   â”œâ”€â”€ tools.py             # Tools do agente
â”‚   â”œâ”€â”€ evolution.py         # Cliente Evolution API
â”‚   â”œâ”€â”€ chatwoot.py          # IntegraÃ§Ã£o Chatwoot
â”‚   â””â”€â”€ notificacoes.py      # Sistema de notificaÃ§Ãµes
â”‚
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ settings.py          # VariÃ¡veis de ambiente
â”‚   â””â”€â”€ prompts.py           # System prompt da JÃºlia
â”‚
â”œâ”€â”€ workers/
â”‚   â””â”€â”€ cadencia_worker.py   # Worker de cadÃªncia
â”‚
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ importar_medicos.py  # Importa lista de mÃ©dicos
â”‚   â””â”€â”€ popular_fila.py      # Popula fila de prospecÃ§Ã£o
â”‚
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ DATABASE.md          # DocumentaÃ§Ã£o do banco
â”‚   â””â”€â”€ ARCHITECTURE.md      # Este documento
â”‚
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ Dockerfile
â””â”€â”€ README.md
```

---

## VariÃ¡veis de Ambiente

```bash
# Supabase
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_SERVICE_KEY=eyJ...

# LLM
ANTHROPIC_API_KEY=sk-ant-...
LLM_MODEL=claude-sonnet-4-20250514

# Evolution API
EVOLUTION_API_URL=http://localhost:8080
EVOLUTION_API_KEY=xxx
EVOLUTION_INSTANCE=julia

# Chatwoot
CHATWOOT_URL=http://localhost:3000
CHATWOOT_API_KEY=xxx
CHATWOOT_ACCOUNT_ID=1
CHATWOOT_INBOX_ID=1

# NotificaÃ§Ãµes
SLACK_WEBHOOK_URL=https://hooks.slack.com/...
GESTOR_WHATSAPP=5511999999999

# CadÃªncia
MAX_MSGS_POR_HORA=20
MAX_MSGS_POR_DIA=100
INTERVALO_MIN_SEG=45
INTERVALO_MAX_SEG=180
HORARIO_INICIO=08:00
HORARIO_FIM=20:00

# Empresa
NOME_EMPRESA=Revoluna
```

---

## ConsideraÃ§Ãµes de SeguranÃ§a

1. **Nunca expor API keys** no cÃ³digo
2. **RLS habilitado** em todas as tabelas sensÃ­veis
3. **Rate limiting** para evitar ban do WhatsApp
4. **Logs de auditoria** em handoffs e aÃ§Ãµes crÃ­ticas
5. **Opt-out** respeitado imediatamente
6. **Dados sensÃ­veis** (CPF, CRM) protegidos

---

## Escalabilidade

| Componente | EstratÃ©gia |
|------------|------------|
| FastAPI | MÃºltiplos workers (uvicorn --workers) |
| CadÃªncia Worker | MÃºltiplas instÃ¢ncias com lock distribuÃ­do |
| WhatsApp | Pool de instÃ¢ncias (whatsapp_instances) |
| Banco | Supabase managed (escala automÃ¡tico) |
| LLM | Rate limiting por cliente |

---

## Monitoramento

| MÃ©trica | Onde ver |
|---------|----------|
| Conversas ativas | GET /api/stats |
| Vagas abertas | GET /api/stats |
| Taxa de resposta | metricas_campanhas |
| Handoffs | handoffs table |
| Erros | notificacoes_gestor |
| Health | GET /api/health |
