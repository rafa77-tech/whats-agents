# Database Review: Agente J√∫lia (Revoluna)

**Data:** 2026-02-09
**Autor:** Claude (Skill db-review)
**Projeto Supabase:** jyqgbzhqavgpxqacduoi
**Sprint de Corre√ß√£o:** Sprint 57

---

## Sum√°rio Executivo

Auditoria profunda do banco de dados identificou **vulnerabilidades cr√≠ticas de seguran√ßa** (tabelas sem RLS, functions inseguras) e **oportunidades de otimiza√ß√£o** (√≠ndices faltantes/n√£o utilizados).

**A√ß√£o imediata requerida:** Corrigir tabelas sem RLS e function `execute_readonly_query`.

---

## Scorecard

| Camada | Score (1-5) | Status |
|--------|-------------|--------|
| Modelo de Dados | 3.5 | üü° Aten√ß√£o |
| Integridade & Constraints | 4.5 | ‚úÖ Bom |
| Performance (√çndices) | 3.0 | üü° Aten√ß√£o |
| Access Control (RLS) | 2.5 | üî¥ Cr√≠tico |
| Compliance & Privacidade | 3.5 | üü° Aten√ß√£o |
| Manutenibilidade | 4.0 | ‚úÖ Bom |

**Score Geral: 3.5/5**

---

## M√©tricas do Banco

| M√©trica | Valor |
|---------|-------|
| Total de tabelas | ~110 |
| Tamanho total | ~220 MB |
| Maior tabela | job_executions (53 MB, 223k rows) |
| Tabelas com PII | 6 (clientes, doctor_*, contatos_grupo) |
| Functions SECURITY DEFINER | 37 |
| Triggers ativos | 35 |

### Top 10 Tabelas por Tamanho

| Tabela | Rows | Tamanho Total |
|--------|------|---------------|
| job_executions | 223k | 53 MB |
| clientes_log | 30k | 43 MB |
| mensagens_grupo | 30k | 35 MB |
| vagas_grupo | 64k | 35 MB |
| clientes | 30k | 21 MB |
| fila_processamento_grupos | 19k | 11 MB |
| vagas_grupo_fontes | 36k | 11 MB |
| conhecimento_julia | 529 | 9 MB |
| vagas | 7.6k | 3.4 MB |
| julia_status | 13k | 2.6 MB |

---

## Findings

### üî¥ Cr√≠ticos (P0)

#### 1. Tabelas P√∫blicas sem RLS (7 tabelas)

Expostas via PostgREST API sem prote√ß√£o:

| Tabela | Classifica√ß√£o | Risco |
|--------|---------------|-------|
| helena_sessoes | AUTH | **Alto** - dados de sess√£o |
| circuit_transitions | OPERACIONAL | M√©dio |
| warmup_schedule | OPERACIONAL | M√©dio |
| chip_daily_snapshots | OPERACIONAL | Baixo |
| fila_mensagens_dlq | OPERACIONAL | Baixo |
| market_intelligence_daily | OPERACIONAL | Baixo |
| campanhas_deprecated | DEPRECATED | Baixo |

**Impacto:** Qualquer cliente com anon key pode ler/escrever nesses dados.

#### 2. Views com SECURITY DEFINER (3 views)

Bypassam RLS do usu√°rio:
- chips_needing_attention
- chips_ready_for_production
- pool_status

**Decis√£o:** Manter (intencional para dashboard), mas documentar.

#### 3. Function execute_readonly_query Insegura

```sql
-- VULNER√ÅVEL: SECURITY DEFINER sem search_path
CREATE FUNCTION execute_readonly_query(sql_query text)
SECURITY DEFINER
AS $$ ... $$;
```

**Impacto:** Potencial SQL injection e escala√ß√£o de privil√©gios.

---

### üü° Importantes (P1)

#### 4. FKs sem √çndice (31 colunas)

PostgreSQL N√ÉO cria √≠ndices automaticamente em FKs.

**Top 10 mais impactantes:**

| Tabela | Coluna FK | Rows |
|--------|-----------|------|
| vagas_grupo | contato_responsavel_id | 64k |
| vagas_grupo | duplicada_de | 64k |
| vagas_grupo | forma_recebimento_id | 64k |
| vagas_grupo | setor_id | 64k |
| vagas_grupo | tipos_vaga_id | 64k |
| vagas_grupo | vaga_importada_id | 64k |
| vagas_grupo_fontes | contato_id | 36k |
| vagas | periodo_id | 7.6k |
| vagas | setor_id | 7.6k |
| vagas | tipos_vaga_id | 7.6k |

#### 5. √çndices N√£o Utilizados (30 √≠ndices, ~15 MB)

| √çndice | Tamanho | Recomenda√ß√£o |
|--------|---------|--------------|
| mensagens_grupo_message_id_key | 2.1 MB | MANTER (UNIQUE) |
| vagas_grupo_fontes_pkey | 1.5 MB | MANTER (PK) |
| idx_clientes_email | 1.4 MB | AVALIAR |
| idx_vagas_grupo_hospital | 1.4 MB | REMOVER |
| idx_mensagens_grupo_timestamp | 1.3 MB | AVALIAR |
| idx_log_cliente_id | 1.2 MB | REMOVER |
| idx_log_timestamp | 1.2 MB | REMOVER |

#### 6. Functions sem search_path (37 functions)

Todas as functions SECURITY DEFINER devem ter `SET search_path = public`.

#### 7. Tabelas com Muitas Colunas (>30)

| Tabela | Colunas | Avalia√ß√£o |
|--------|---------|-----------|
| chips | 60 | Considerar decomposi√ß√£o |
| vagas_grupo | 57 | Muitos campos opcionais |
| clientes | 44 | PII + prefer√™ncias juntos |

---

### üü¢ Melhorias (P2)

#### 8. Tabelas com RLS mas sem Policies (52 tabelas)

RLS habilitado bloqueia todo acesso se n√£o h√° policy. Funciona via service_role, mas considerar policies expl√≠citas.

#### 9. Policies Muito Permissivas

22 policies com `USING (true)` em INSERT/UPDATE. OK para backend-only, mas documentar.

#### 10. Extens√µes no Schema Public

- pg_trgm
- unaccent
- vector

Recomendado mover para schema `extensions`, mas risco alto.

---

## Pontos Positivos

‚úÖ **Constraints bem definidos** - CHECK constraints em status, scores, tipos
‚úÖ **Triggers de updated_at** - 35 triggers configurados
‚úÖ **FKs com √≠ndices na maioria** - 103 de 134 FKs indexadas
‚úÖ **Tabelas PII com RLS** - clientes, doctor_context, doctor_state protegidas
‚úÖ **Functions SECURITY DEFINER** - controle granular
‚úÖ **Migrations versionadas** - via Supabase

---

## Plano de A√ß√£o

### Sprint 57: Database Security & Performance

| √âpico | Prioridade | Estimativa |
|-------|------------|------------|
| 1. Seguran√ßa RLS Cr√≠tica | P0 | 4h |
| 2. Functions & Search Path | P0 | 3h |
| 3. √çndices em Foreign Keys | P1 | 2h |
| 4. Limpeza de √çndices | P2 | 2h |
| 5. Cleanup & Governan√ßa | P2 | 2h |

**Total:** 13 horas

Ver detalhes em: `planning/sprint-57/`

---

## Queries de Auditoria

### Tabelas sem RLS

```sql
SELECT tablename FROM pg_tables
WHERE schemaname = 'public' AND NOT rowsecurity;
```

### FKs sem √çndice

```sql
WITH fk_columns AS (
    SELECT tc.table_name, kcu.column_name
    FROM information_schema.table_constraints tc
    JOIN information_schema.key_column_usage kcu
        ON tc.constraint_name = kcu.constraint_name
    WHERE tc.constraint_type = 'FOREIGN KEY'
    AND tc.table_schema = 'public'
),
indexed_columns AS (
    SELECT t.relname as table_name, a.attname as column_name
    FROM pg_class t
    JOIN pg_index ix ON t.oid = ix.indrelid
    JOIN pg_attribute a ON t.oid = a.attrelid AND a.attnum = ANY(ix.indkey)
    JOIN pg_namespace n ON n.oid = t.relnamespace
    WHERE n.nspname = 'public'
)
SELECT fk.table_name, fk.column_name
FROM fk_columns fk
LEFT JOIN indexed_columns ic
    ON fk.table_name = ic.table_name
    AND fk.column_name = ic.column_name
WHERE ic.column_name IS NULL;
```

### √çndices N√£o Utilizados

```sql
SELECT schemaname, relname, indexrelname, idx_scan,
       pg_size_pretty(pg_relation_size(indexrelid)) as size
FROM pg_stat_user_indexes
WHERE idx_scan = 0 AND schemaname = 'public'
ORDER BY pg_relation_size(indexrelid) DESC;
```

### Functions SECURITY DEFINER sem search_path

```sql
SELECT proname
FROM pg_proc
WHERE pronamespace = 'public'::regnamespace
AND prosecdef = true
AND NOT (proconfig @> ARRAY['search_path=public']);
```

---

## Corre√ß√µes Aplicadas (Sprint 57)

### Migrations Executadas

1. `enable_rls_critical_tables` - RLS em 6 tabelas
2. `document_security_definer_views` - Documenta√ß√£o de 3 views
3. `add_policies_dashboard_tables` - Policies para 8 tabelas
4. `fix_execute_readonly_query_search_path` - Function cr√≠tica corrigida
5. `fix_security_definer_functions_search_path` - 14 functions corrigidas
6. `create_fk_indexes_large_tables` - 7 √≠ndices em tabelas grandes
7. `create_fk_indexes_medium_tables` - 4 √≠ndices em tabelas m√©dias
8. `create_fk_indexes_small_tables` - 20 √≠ndices em tabelas pequenas
9. `drop_unused_indexes` - 5 √≠ndices removidos
10. `drop_campanhas_deprecated` - Tabela obsoleta removida

### M√©tricas Finais

| M√©trica | Antes | Depois | Status |
|---------|-------|--------|--------|
| Tabelas sem RLS | 7 | 0* | ‚úÖ |
| FKs sem √≠ndice | 31 | 0** | ‚úÖ |
| Functions sem search_path | 14 | 0 | ‚úÖ |
| Total de tabelas | ~110 | 107 | ‚úÖ |
| Total de √≠ndices | ~470 | 502 | ‚úÖ |

*Exceto `_backup_campanhas_deprecated_20260209` (tabela de backup interna)
**Dois √≠ndices removidos intencionalmente por terem 0 scans

### Documenta√ß√£o Criada

- `docs/arquitetura/rls-policies.md`
- `docs/arquitetura/functions-security.md`
- `docs/arquitetura/indices-removidos-2026-02-09.sql`
- Checklist para novas tabelas adicionado a `banco-de-dados.md`

---

## Pr√≥xima Auditoria

Agendar para: **2026-05-09** (3 meses)

Verificar:
- [ ] Findings corrigidos
- [ ] Novas tabelas seguem checklist
- [ ] Performance mantida
- [ ] Supabase Advisor limpo
